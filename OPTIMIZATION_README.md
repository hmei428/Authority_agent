# æ€§èƒ½ä¼˜åŒ–å’Œè§£è€¦æ–¹æ¡ˆ

## ä¼˜åŒ–æ¦‚è§ˆ

å®æ–½äº†ä»¥ä¸‹3é¡¹ä¼˜åŒ–ï¼Œå¹¶æ–°å¢äº†å…ƒæœç´¢ä¸æ‰“åˆ†è§£è€¦åŠŸèƒ½ï¼š

### âœ… ä¼˜åŒ–1ï¼šè¿æ¥å¤ç”¨ + ç¼“å­˜
- **OpenAI Clientå¤ç”¨**ï¼šé¿å…æ¯æ¬¡è¯·æ±‚åˆ›å»ºæ–°è¿æ¥
- **requests.Sessionå¤ç”¨**ï¼šå…ƒæœç´¢ä½¿ç”¨æŒä¹…è¿æ¥
- **æ‰“åˆ†ç»“æœç¼“å­˜**ï¼šç›¸åŒhost/query-contentä¸é‡å¤æ‰“åˆ†

### âœ… ä¼˜åŒ–2ï¼šå¹¶è¡Œæ‰“åˆ†
- **æƒå¨æ€§å’Œç›¸å…³æ€§å¹¶è¡Œ**ï¼šä»ä¸²è¡Œ5.2s â†’ å¹¶è¡Œ2.6s
- **æä¾› `score_both_parallel()` å‡½æ•°**

### âœ… ä¼˜åŒ–3ï¼šç¼©çŸ­è¶…æ—¶å’Œé‡è¯•
- **å…ƒæœç´¢timeout**ï¼š15s â†’ 8s
- **é‡è¯•æ¬¡æ•°**ï¼š3æ¬¡ â†’ 2æ¬¡
- **é‡è¯•å»¶è¿Ÿ**ï¼š1s â†’ 0.3s
- **max_tokens**ï¼š512 â†’ 128ï¼ˆåªéœ€ç®€å•JSONï¼‰

### ğŸ†• æ–°å¢åŠŸèƒ½ï¼šå…ƒæœç´¢ä¸æ‰“åˆ†è§£è€¦

#### è¾“å‡ºæ–°æ–‡ä»¶ï¼š`metasearch_results.csv`
åŒ…å«å­—æ®µï¼šquery, rank, url, title, content, host

#### ä¼˜åŠ¿ï¼š
1. **é¿å…é‡å¤æœç´¢**ï¼šè°ƒæ•´æ‰“åˆ†å‚æ•°æ—¶æ— éœ€é‡æ–°è°ƒç”¨å…ƒæœç´¢API
2. **é€Ÿåº¦æ›´å¿«**ï¼šç›´æ¥è¯»CSVæ‰“åˆ†ï¼Œè·³è¿‡å…ƒæœç´¢ç¯èŠ‚
3. **æˆæœ¬ä¼˜åŒ–**ï¼šå…ƒæœç´¢APIè°ƒç”¨æˆæœ¬é«˜ï¼Œé¿å…æµªè´¹
4. **çµæ´»è°ƒè¯•**ï¼šå¯ä»¥å•ç‹¬æµ‹è¯•æ‰“åˆ†é€»è¾‘

---

## ä½¿ç”¨æ–¹å¼

### æ–¹å¼1ï¼šå®Œæ•´æµç¨‹ï¼ˆæ¨èé¦–æ¬¡è¿è¡Œï¼‰

```bash
# æ‰§è¡Œå®Œæ•´æµç¨‹ï¼šå…ƒæœç´¢ + æ‰“åˆ†
bash run_pipeline_local.sh
```

**è¾“å‡ºæ–‡ä»¶ï¼š**
- `metasearch_results.csv` - å…ƒæœç´¢åŸå§‹ç»“æœ
- `all_results_with_scores.csv` - æ‰€æœ‰ç»“æœå¸¦è¯„åˆ†
- `authority_hosts.csv` - æƒå¨hoståˆ—è¡¨
- `filtered_qna.csv` - ç­›é€‰åçš„é«˜è´¨é‡ç»“æœ

---

### æ–¹å¼2ï¼šä»metasearch_results.csvé‡æ–°æ‰“åˆ†

å¦‚æœå·²ç»æœ‰äº† `metasearch_results.csv`ï¼Œæƒ³è°ƒæ•´æ‰“åˆ†å‚æ•°é‡æ–°æ‰“åˆ†ï¼š

```bash
python score_from_metasearch.py \
  --input-csv ./outputs/20251119/metasearch_results.csv \
  --output-dir ./outputs/20251119/rescore_v2 \
  --authority-threshold 3 \
  --relevance-threshold 1 \
  --filter-authority-score 4 \
  --filter-relevance-score 2 \
  --max-workers 32
```

**å‚æ•°è¯´æ˜ï¼š**
- `--input-csv`: metasearch_results.csv è·¯å¾„
- `--output-dir`: è¾“å‡ºç›®å½•
- `--authority-threshold`: æƒå¨æ€§é˜ˆå€¼ï¼ˆæ”¶é›†é˜ˆå€¼ï¼‰
- `--relevance-threshold`: ç›¸å…³æ€§é˜ˆå€¼ï¼ˆæ”¶é›†é˜ˆå€¼ï¼‰
- `--filter-authority-score`: æ–‡ä»¶3çš„æƒå¨æ€§ç­›é€‰ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰
- `--filter-relevance-score`: æ–‡ä»¶3çš„ç›¸å…³æ€§ç­›é€‰ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰
- `--max-workers`: å¹¶å‘æ•°

---

## æ€§èƒ½å¯¹æ¯”

### ä¼˜åŒ–å‰
- **å•ä¸ªqueryè€—æ—¶**ï¼š~54s
  - å…ƒæœç´¢: 2s
  - 10ä¸ªé“¾æ¥ä¸²è¡Œæ‰“åˆ†: 52s (æƒå¨2.6s + ç›¸å…³2.6s) Ã— 10

### ä¼˜åŒ–å
- **å•ä¸ªqueryè€—æ—¶**ï¼š~3-4s
  - å…ƒæœç´¢: 1.5s (è¿æ¥å¤ç”¨+timeoutä¼˜åŒ–)
  - 10ä¸ªé“¾æ¥å¹¶è¡Œæ‰“åˆ†: 2.6s (æƒå¨+ç›¸å…³å¹¶è¡Œ)
  - ç¼“å­˜å‘½ä¸­æ—¶æ›´å¿«: ~1s

**åŠ é€Ÿæ¯”ï¼šçº¦ 13-18å€** ğŸš€

---

## æ–‡ä»¶è¯´æ˜

### æ–°å¢æ–‡ä»¶

1. **`search_agent/scoring_optimized.py`**
   - ä¼˜åŒ–åçš„æ‰“åˆ†æ¨¡å—
   - åŒ…å«ç¼“å­˜ã€è¿æ¥å¤ç”¨ã€å¹¶è¡Œæ‰“åˆ†

2. **`score_from_metasearch.py`**
   - ä»metasearch_results.csvè¯»å–å¹¶æ‰“åˆ†
   - ç‹¬ç«‹è„šæœ¬ï¼Œå¯é‡å¤è¿è¡Œ

### ä¿®æ”¹æ–‡ä»¶

1. **`search_agent/search_client.py`**
   - æ·»åŠ  requests.Session å¤ç”¨
   - timeout 15s â†’ 8s

2. **`search_agent/pipeline.py`**
   - æ–°å¢ `metasearch_results` åˆ—è¡¨
   - åœ¨ `fetch_results()` ä¸­æ”¶é›†åŸå§‹ç»“æœ
   - åœ¨ `flush_outputs_csv()` ä¸­è¾“å‡º metasearch_results.csv

3. **`main_pipeline.py`**
   - å¯¼å…¥ä¼˜åŒ–åçš„ scoring_optimized æ¨¡å—

4. **`run_pipeline_local.sh`**
   - æ›´æ–°è¾“å‡ºæ–‡ä»¶è¯´æ˜
   - æ·»åŠ é‡æ–°æ‰“åˆ†çš„ç¤ºä¾‹å‘½ä»¤

---

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šé¦–æ¬¡è¿è¡Œ
```bash
bash run_pipeline_local.sh
```

### åœºæ™¯2ï¼šè°ƒæ•´æ‰“åˆ†å‚æ•°
è°ƒæ•´ authority_threshold ä» 2 â†’ 3ï¼Œé‡æ–°æ‰“åˆ†ï¼š
```bash
python score_from_metasearch.py \
  --input-csv ./outputs/20251119/metasearch_results.csv \
  --output-dir ./outputs/20251119/authority_3 \
  --authority-threshold 3
```

### åœºæ™¯3ï¼šè°ƒæ•´ç­›é€‰æ¡ä»¶
è°ƒæ•´ filtered_qna.csv çš„ç­›é€‰æ¡ä»¶ï¼š
```bash
python score_from_metasearch.py \
  --input-csv ./outputs/20251119/metasearch_results.csv \
  --output-dir ./outputs/20251119/filter_3_2 \
  --filter-authority-score 3 \
  --filter-relevance-score 2
```

### åœºæ™¯4ï¼šç¼“å­˜æµ‹è¯•
ç¬¬äºŒæ¬¡è¿è¡Œç›¸åŒæ•°æ®æ—¶ï¼Œç¼“å­˜ä¼šåŠ é€Ÿï¼š
```bash
# ç¬¬ä¸€æ¬¡ï¼š~3-4s/query
python score_from_metasearch.py --input-csv data.csv --output-dir run1

# ç¬¬äºŒæ¬¡ï¼š~1s/queryï¼ˆç¼“å­˜å‘½ä¸­ï¼‰
python score_from_metasearch.py --input-csv data.csv --output-dir run2
```

---

## æ³¨æ„äº‹é¡¹

1. **ç¼“å­˜æ˜¯å…¨å±€çš„**ï¼šåœ¨åŒä¸€ä¸ªPythonè¿›ç¨‹ä¸­ï¼Œç¼“å­˜ä¼šä¸€ç›´ä¿ç•™
2. **ç¼“å­˜é€‚ç”¨äº**ï¼š
   - ç›¸åŒ host çš„æƒå¨æ€§æ‰“åˆ†
   - ç›¸åŒ (query, title, content) çš„ç›¸å…³æ€§æ‰“åˆ†
3. **APIè¿æ¥å¤ç”¨**ï¼šé¦–æ¬¡è°ƒç”¨åclientä¼šè¢«å¤ç”¨
4. **çº¿ç¨‹å®‰å…¨**ï¼šæ‰€æœ‰ä¼˜åŒ–éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„

---

## å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆéœ€è¦ä¸¤ç§è¿è¡Œæ–¹å¼ï¼Ÿ**
A: å®Œæ•´æµç¨‹é€‚åˆé¦–æ¬¡è¿è¡Œï¼›ä»CSVæ‰“åˆ†é€‚åˆè°ƒå‚å®éªŒï¼Œé¿å…é‡å¤è°ƒç”¨å…ƒæœç´¢APIã€‚

**Q: metasearch_results.csv å’Œ all_results_with_scores.csv æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**
A: å‰è€…åªæœ‰å…ƒæœç´¢ç»“æœï¼ˆæ— è¯„åˆ†ï¼‰ï¼Œåè€…åŒ…å«è¯„åˆ†ã€‚å‰è€…å¯ç”¨äºé‡æ–°æ‰“åˆ†ã€‚

**Q: ç¼“å­˜ä¼šå ç”¨å¤šå°‘å†…å­˜ï¼Ÿ**
A: å¾ˆå°‘ã€‚æ¯ä¸ªhostçº¦50å­—èŠ‚ï¼Œæ¯ä¸ªquery-contentç»„åˆçº¦100å­—èŠ‚ã€‚å¤„ç†10ä¸‡æ¡è®°å½•çº¦10MBã€‚

**Q: å¦‚ä½•æ¸…ç©ºç¼“å­˜ï¼Ÿ**
A: é‡å¯Pythonè¿›ç¨‹å³å¯æ¸…ç©ºç¼“å­˜ã€‚

---

## ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹æ—¥å¿—
```bash
tail -f ./logs/pipeline_*.log
```

### ç»Ÿè®¡ç¼“å­˜å‘½ä¸­ç‡
åœ¨scoring_optimized.pyä¸­å¯ä»¥æ·»åŠ è®¡æ•°å™¨ï¼š
```python
cache_hits = 0
cache_misses = 0
```

---

## è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

1. **ä½¿ç”¨å¼‚æ­¥IO**ï¼šå¦‚æœAPIæ”¯æŒï¼Œå¯ä»¥ä»ThreadPoolExecutoræ”¹ä¸ºasyncio
2. **æ‰¹é‡APIè°ƒç”¨**ï¼šå¦‚æœAPIæ”¯æŒbatchï¼Œå¯ä»¥å‡å°‘è¯·æ±‚æ¬¡æ•°
3. **æŒä¹…åŒ–ç¼“å­˜**ï¼šå°†ç¼“å­˜ä¿å­˜åˆ°Redisæˆ–æ–‡ä»¶ï¼Œè·¨è¿›ç¨‹å¤ç”¨
4. **promptå‹ç¼©**ï¼šè¿›ä¸€æ­¥ç²¾ç®€prompté•¿åº¦

---

## æ€»ç»“

é€šè¿‡3é¡¹ä¼˜åŒ– + å…ƒæœç´¢æ‰“åˆ†è§£è€¦ï¼Œå®ç°äº†ï¼š
- âœ… **13-18å€åŠ é€Ÿ**
- âœ… **é¿å…é‡å¤è°ƒç”¨å…ƒæœç´¢API**
- âœ… **çµæ´»è°ƒæ•´æ‰“åˆ†å‚æ•°**
- âœ… **é™ä½æˆæœ¬å’Œå»¶è¿Ÿ**
